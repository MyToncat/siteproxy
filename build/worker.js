var we={Stringify:1,BeforeStream:2,Stream:3},Xe=(e,t)=>{let o=new String(e);return o.isEscaped=!0,o.callbacks=t,o};var ae=async(e,t,o,r,s)=>{let n=e.callbacks;if(!n?.length)return Promise.resolve(e);s?s[0]+=e:s=[e];let i=Promise.all(n.map(c=>c({phase:t,buffer:s,context:r}))).then(c=>Promise.all(c.filter(Boolean).map(a=>ae(a,t,!1,r,s))).then(()=>s[0]));return o?Xe(await i,n):i};var ve=(e,t,o)=>{if(!t.has(e))throw TypeError("Cannot "+o)},l=(e,t,o)=>(ve(e,t,"read from private field"),o?o.call(e):t.get(e)),D=(e,t,o)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,o)},R=(e,t,o,r)=>(ve(e,t,"write to private field"),r?r.call(e,o):t.set(e,o),o),Qe="text/plain; charset=UTF-8",ce=(e,t={})=>(Object.entries(t).forEach(([o,r])=>e.set(o,r)),e),W,I,y,u,P,N,B=class{constructor(e,t){this.env={},this._var={},this.finalized=!1,this.error=void 0,D(this,W,200),D(this,I,void 0),D(this,y,void 0),D(this,u,void 0),D(this,P,void 0),D(this,N,!0),this.layout=void 0,this.renderer=o=>this.html(o),this.notFoundHandler=()=>new Response,this.render=(...o)=>this.renderer(...o),this.setLayout=o=>this.layout=o,this.getLayout=()=>this.layout,this.setRenderer=o=>{this.renderer=o},this.header=(o,r,s)=>{if(r===void 0){l(this,y)?l(this,y).delete(o):l(this,u)&&delete l(this,u)[o.toLocaleLowerCase()],this.finalized&&this.res.headers.delete(o);return}s?.append?(l(this,y)||(R(this,N,!1),R(this,y,new Headers(l(this,u))),R(this,u,{})),l(this,y).append(o,r)):l(this,y)?l(this,y).set(o,r):(l(this,u)??R(this,u,{}),l(this,u)[o.toLowerCase()]=r),this.finalized&&(s?.append?this.res.headers.append(o,r):this.res.headers.set(o,r))},this.status=o=>{R(this,N,!1),R(this,W,o)},this.set=(o,r)=>{this._var??(this._var={}),this._var[o]=r},this.get=o=>this._var?this._var[o]:void 0,this.newResponse=(o,r,s)=>{if(l(this,N)&&!s&&!r&&l(this,W)===200)return new Response(o,{headers:l(this,u)});if(r&&typeof r!="number"){let i=ce(new Headers(r.headers),l(this,u));return new Response(o,{headers:i,status:r.status??l(this,W)})}let n=typeof r=="number"?r:l(this,W);l(this,u)??R(this,u,{}),l(this,y)??R(this,y,new Headers),ce(l(this,y),l(this,u)),l(this,P)&&(l(this,P).headers.forEach((i,c)=>{l(this,y)?.set(c,i)}),ce(l(this,y),l(this,u))),s??(s={});for(let[i,c]of Object.entries(s))if(typeof c=="string")l(this,y).set(i,c);else{l(this,y).delete(i);for(let a of c)l(this,y).append(i,a)}return new Response(o,{status:n,headers:l(this,y)})},this.body=(o,r,s)=>typeof r=="number"?this.newResponse(o,r,s):this.newResponse(o,r),this.text=(o,r,s)=>{if(!l(this,u)){if(l(this,N)&&!s&&!r)return new Response(o);R(this,u,{})}return l(this,u)["content-type"]=Qe,typeof r=="number"?this.newResponse(o,r,s):this.newResponse(o,r)},this.json=(o,r,s)=>{let n=JSON.stringify(o);return l(this,u)??R(this,u,{}),l(this,u)["content-type"]="application/json; charset=UTF-8",typeof r=="number"?this.newResponse(n,r,s):this.newResponse(n,r)},this.html=(o,r,s)=>(l(this,u)??R(this,u,{}),l(this,u)["content-type"]="text/html; charset=UTF-8",typeof o=="object"&&(o instanceof Promise||(o=o.toString()),o instanceof Promise)?o.then(n=>ae(n,we.Stringify,!1,{})).then(n=>typeof r=="number"?this.newResponse(n,r,s):this.newResponse(n,r)):typeof r=="number"?this.newResponse(o,r,s):this.newResponse(o,r)),this.redirect=(o,r=302)=>(l(this,y)??R(this,y,new Headers),l(this,y).set("Location",o),this.newResponse(null,r)),this.notFound=()=>this.notFoundHandler(this),this.req=e,t&&(R(this,I,t.executionCtx),this.env=t.env,t.notFoundHandler&&(this.notFoundHandler=t.notFoundHandler))}get event(){if(l(this,I)&&"respondWith"in l(this,I))return l(this,I);throw Error("This context has no FetchEvent")}get executionCtx(){if(l(this,I))return l(this,I);throw Error("This context has no ExecutionContext")}get res(){return R(this,N,!1),l(this,P)||R(this,P,new Response("404 Not Found",{status:404}))}set res(e){if(R(this,N,!1),l(this,P)&&e){l(this,P).headers.delete("content-type");for(let[t,o]of l(this,P).headers.entries())if(t==="set-cookie"){let r=l(this,P).headers.getSetCookie();e.headers.delete("set-cookie");for(let s of r)e.headers.append("set-cookie",s)}else e.headers.set(t,o)}R(this,P,e),this.finalized=!0}get var(){return{...this._var}}};W=new WeakMap;I=new WeakMap;y=new WeakMap;u=new WeakMap;P=new WeakMap;N=new WeakMap;var xe=(e,t,o)=>(r,s)=>{let n=-1;return i(0);async function i(c){if(c<=n)throw new Error("next() called multiple times");n=c;let a,x=!1,f;if(e[c]?(f=e[c][0][0],r instanceof B&&(r.req.routeIndex=c)):f=c===e.length&&s||void 0,!f)r instanceof B&&r.finalized===!1&&o&&(a=await o(r));else try{a=await f(r,()=>i(c+1))}catch(_){if(_ instanceof Error&&r instanceof B&&t)r.error=_,a=await t(_,r),x=!0;else throw _}return a&&(r.finalized===!1||x)&&(r.res=a),r}};var Ee=class extends Error{constructor(e=500,t){super(t?.message),this.res=t?.res,this.status=e}getResponse(){return this.res?this.res:new Response(this.message,{status:this.status})}};var Re=async(e,t={all:!1})=>{let r=(e instanceof Y?e.raw.headers:e.headers).get("Content-Type");return Je(r)?Ze(e,t):{}};function Je(e){return e===null?!1:e.startsWith("multipart/form-data")||e.startsWith("application/x-www-form-urlencoded")}async function Ze(e,t){let o=await e.formData();return o?et(o,t):{}}function et(e,t){let o={};return e.forEach((r,s)=>{t.all||s.endsWith("[]")?tt(o,s,r):o[s]=r}),o}var tt=(e,t,o)=>{e[t]&&rt(e[t])?ot(e[t],o):e[t]?st(e,t,o):e[t]=o};function rt(e){return Array.isArray(e)}var ot=(e,t)=>{e.push(t)},st=(e,t,o)=>{e[t]=[e[t],o]};var _e=e=>{let t=e.split("/");return t[0]===""&&t.shift(),t},ke=e=>{let{groups:t,path:o}=nt(e),r=_e(o);return it(r,t)},nt=e=>{let t=[];return e=e.replace(/\{[^}]+\}/g,(o,r)=>{let s=`@${r}`;return t.push([s,o]),s}),{groups:t,path:e}},it=(e,t)=>{for(let o=t.length-1;o>=0;o--){let[r]=t[o];for(let s=e.length-1;s>=0;s--)if(e[s].includes(r)){e[s]=e[s].replace(r,t[o][1]);break}}return e},X={},le=e=>{if(e==="*")return"*";let t=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);return t?(X[e]||(t[2]?X[e]=[e,t[1],new RegExp("^"+t[2]+"$")]:X[e]=[e,t[1],!0]),X[e]):null},de=e=>{let t=e.url.match(/^https?:\/\/[^/]+(\/[^?]*)/);return t?t[1]:""},Se=e=>{let t=e.indexOf("?",8);return t===-1?"":"?"+e.slice(t+1)},Ce=e=>{let t=de(e);return t.length>1&&t[t.length-1]==="/"?t.slice(0,-1):t},F=(...e)=>{let t="",o=!1;for(let r of e)t[t.length-1]==="/"&&(t=t.slice(0,-1),o=!0),r[0]!=="/"&&(r=`/${r}`),r==="/"&&o?t=`${t}/`:r!=="/"&&(t=`${t}${r}`),r==="/"&&t===""&&(t="/");return t},Q=e=>{if(!e.match(/\:.+\?$/))return null;let t=e.split("/"),o=[],r="";return t.forEach(s=>{if(s!==""&&!/\:/.test(s))r+="/"+s;else if(/\:/.test(s))if(/\?/.test(s)){o.length===0&&r===""?o.push("/"):o.push(r);let n=s.replace("?","");r+="/"+n,o.push(r)}else r+="/"+s}),o.filter((s,n,i)=>i.indexOf(s)===n)},fe=e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),/%/.test(e)?J(e):e):e,He=(e,t,o)=>{let r;if(!o&&t&&!/[%+]/.test(t)){let i=e.indexOf(`?${t}`,8);for(i===-1&&(i=e.indexOf(`&${t}`,8));i!==-1;){let c=e.charCodeAt(i+t.length+1);if(c===61){let a=i+t.length+2,x=e.indexOf("&",a);return fe(e.slice(a,x===-1?void 0:x))}else if(c==38||isNaN(c))return"";i=e.indexOf(`&${t}`,i+1)}if(r=/[%+]/.test(e),!r)return}let s={};r??(r=/[%+]/.test(e));let n=e.indexOf("?",8);for(;n!==-1;){let i=e.indexOf("&",n+1),c=e.indexOf("=",n);c>i&&i!==-1&&(c=-1);let a=e.slice(n+1,c===-1?i===-1?void 0:i:c);if(r&&(a=fe(a)),n=i,a==="")continue;let x;c===-1?x="":(x=e.slice(c+1,i===-1?void 0:i),r&&(x=fe(x))),o?(s[a]&&Array.isArray(s[a])||(s[a]=[]),s[a].push(x)):s[a]??(s[a]=x)}return t?s[t]:s},Oe=He,Ae=(e,t)=>He(e,t,!0),J=decodeURIComponent;var Me=(e,t,o)=>{if(!t.has(e))throw TypeError("Cannot "+o)},T=(e,t,o)=>(Me(e,t,"read from private field"),o?o.call(e):t.get(e)),Pe=(e,t,o)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,o)},$e=(e,t,o,r)=>(Me(e,t,"write to private field"),r?r.call(e,o):t.set(e,o),o),z,M,Y=class{constructor(e,t="/",o=[[]]){Pe(this,z,void 0),Pe(this,M,void 0),this.routeIndex=0,this.bodyCache={},this.cachedBody=r=>{let{bodyCache:s,raw:n}=this,i=s[r];return i||(s.arrayBuffer?(async()=>await new Response(s.arrayBuffer)[r]())():s[r]=n[r]())},this.raw=e,this.path=t,$e(this,M,o),$e(this,z,{})}param(e){return e?this.getDecodedParam(e):this.getAllDecodedParams()}getDecodedParam(e){let t=T(this,M)[0][this.routeIndex][1][e],o=this.getParamValue(t);return o?/\%/.test(o)?J(o):o:void 0}getAllDecodedParams(){let e={},t=Object.keys(T(this,M)[0][this.routeIndex][1]);for(let o of t){let r=this.getParamValue(T(this,M)[0][this.routeIndex][1][o]);r&&typeof r=="string"&&(e[o]=/\%/.test(r)?J(r):r)}return e}getParamValue(e){return T(this,M)[1]?T(this,M)[1][e]:e}query(e){return Oe(this.url,e)}queries(e){return Ae(this.url,e)}header(e){if(e)return this.raw.headers.get(e.toLowerCase())??void 0;let t={};return this.raw.headers.forEach((o,r)=>{t[r]=o}),t}async parseBody(e){if(this.bodyCache.parsedBody)return this.bodyCache.parsedBody;let t=await Re(this,e);return this.bodyCache.parsedBody=t,t}json(){return this.cachedBody("json")}text(){return this.cachedBody("text")}arrayBuffer(){return this.cachedBody("arrayBuffer")}blob(){return this.cachedBody("blob")}formData(){return this.cachedBody("formData")}addValidatedData(e,t){T(this,z)[e]=t}valid(e){return T(this,z)[e]}get url(){return this.raw.url}get method(){return this.raw.method}get matchedRoutes(){return T(this,M)[0].map(([[,e]])=>e)}get routePath(){return T(this,M)[0].map(([[,e]])=>e)[this.routeIndex].path}};z=new WeakMap;M=new WeakMap;var m="ALL",Le="all",Z=["get","post","put","delete","options","patch"],ee="Can not add a route since the matcher is already built.",te=class extends Error{};var Ie=(e,t,o)=>{if(!t.has(e))throw TypeError("Cannot "+o)},re=(e,t,o)=>(Ie(e,t,"read from private field"),o?o.call(e):t.get(e)),at=(e,t,o)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,o)},oe=(e,t,o,r)=>(Ie(e,t,"write to private field"),r?r.call(e,o):t.set(e,o),o),ct=Symbol("composedHandler");function xt(){return class{}}var ft=e=>e.text("404 Not Found",404),Te=(e,t)=>e instanceof Ee?e.getResponse():(console.error(e),t.text("Internal Server Error",500)),L,Ne=class extends xt(){constructor(e={}){super(),this._basePath="/",at(this,L,"/"),this.routes=[],this.notFoundHandler=ft,this.errorHandler=Te,this.onError=r=>(this.errorHandler=r,this),this.notFound=r=>(this.notFoundHandler=r,this),this.fetch=(r,s,n)=>this.dispatch(r,n,s,r.method),this.request=(r,s,n,i)=>{if(r instanceof Request)return s!==void 0&&(r=new Request(r,s)),this.fetch(r,n,i);r=r.toString();let c=/^https?:\/\//.test(r)?r:`http://localhost${F("/",r)}`,a=new Request(c,s);return this.fetch(a,n,i)},this.fire=()=>{addEventListener("fetch",r=>{r.respondWith(this.dispatch(r.request,r,void 0,r.request.method))})},[...Z,Le].map(r=>{this[r]=(s,...n)=>(typeof s=="string"?oe(this,L,s):this.addRoute(r,re(this,L),s),n.map(i=>{typeof i!="string"&&this.addRoute(r,re(this,L),i)}),this)}),this.on=(r,s,...n)=>{if(!r)return this;for(let i of[s].flat()){oe(this,L,i);for(let c of[r].flat())n.map(a=>{this.addRoute(c.toUpperCase(),re(this,L),a)})}return this},this.use=(r,...s)=>(typeof r=="string"?oe(this,L,r):(oe(this,L,"*"),s.unshift(r)),s.map(n=>{this.addRoute(m,re(this,L),n)}),this);let o=e.strict??!0;delete e.strict,Object.assign(this,e),this.getPath=o?e.getPath??de:Ce}clone(){let e=new Ne({router:this.router,getPath:this.getPath});return e.routes=this.routes,e}route(e,t){let o=this.basePath(e);return t?(t.routes.map(r=>{let s;t.errorHandler===Te?s=r.handler:(s=async(n,i)=>(await xe([],t.errorHandler)(n,()=>r.handler(n,i))).res,s[ct]=r.handler),o.addRoute(r.method,r.path,s)}),this):o}basePath(e){let t=this.clone();return t._basePath=F(this._basePath,e),t}mount(e,t,o){let r=F(this._basePath,e),s=r==="/"?0:r.length,n=async(i,c)=>{let a;try{a=i.executionCtx}catch{}let x=o?o(i):[i.env,a],f=Array.isArray(x)?x:[x],_=Se(i.req.url),h=await t(new Request(new URL((i.req.path.slice(s)||"/")+_,i.req.url),i.req.raw),...f);if(h)return h;await c()};return this.addRoute(m,F(e,"*"),n),this}addRoute(e,t,o){e=e.toUpperCase(),t=F(this._basePath,t);let r={path:t,method:e,handler:o};this.router.add(e,t,[o,r]),this.routes.push(r)}matchRoute(e,t){return this.router.match(e,t)}handleError(e,t){if(e instanceof Error)return this.errorHandler(e,t);throw e}dispatch(e,t,o,r){if(r==="HEAD")return(async()=>new Response(null,await this.dispatch(e,t,o,"GET")))();let s=this.getPath(e,{env:o}),n=this.matchRoute(r,s),i=new B(new Y(e,s,n),{env:o,executionCtx:t,notFoundHandler:this.notFoundHandler});if(n[0].length===1){let a;try{a=n[0][0][0][0](i,async()=>{i.res=await this.notFoundHandler(i)})}catch(x){return this.handleError(x,i)}return a instanceof Promise?a.then(x=>x||(i.finalized?i.res:this.notFoundHandler(i))).catch(x=>this.handleError(x,i)):a}let c=xe(n[0],this.errorHandler,this.notFoundHandler);return(async()=>{try{let a=await c(i);if(!a.finalized)throw new Error("Context is not finalized. You may forget returning Response object or `await next()`");return a.res}catch(a){return this.handleError(a,i)}})()}},Ue=Ne;L=new WeakMap;var se="[^/]+",G=".*",K="(?:|/.*)",q=Symbol();function _t(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===G||e===K?1:t===G||t===K?-1:e===se?1:t===se?-1:e.length===t.length?e<t?-1:1:t.length-e.length}var ne=class{constructor(){this.children={}}insert(e,t,o,r,s){if(e.length===0){if(this.index!==void 0)throw q;if(s)return;this.index=t;return}let[n,...i]=e,c=n==="*"?i.length===0?["","",G]:["","",se]:n==="/*"?["","",K]:n.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/),a;if(c){let x=c[1],f=c[2]||se;if(x&&c[2]&&(f=f.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(f)))throw q;if(a=this.children[f],!a){if(Object.keys(this.children).some(_=>_!==G&&_!==K))throw q;if(s)return;a=this.children[f]=new ne,x!==""&&(a.varIndex=r.varIndex++)}!s&&x!==""&&o.push([x,a.varIndex])}else if(a=this.children[n],!a){if(Object.keys(this.children).some(x=>x.length>1&&x!==G&&x!==K))throw q;if(s)return;a=this.children[n]=new ne}a.insert(i,t,o,r,s)}buildRegExpStr(){let t=Object.keys(this.children).sort(_t).map(o=>{let r=this.children[o];return(typeof r.varIndex=="number"?`(${o})@${r.varIndex}`:o)+r.buildRegExpStr()});return typeof this.index=="number"&&t.unshift(`#${this.index}`),t.length===0?"":t.length===1?t[0]:"(?:"+t.join("|")+")"}};var De=class{constructor(){this.context={varIndex:0},this.root=new ne}insert(e,t,o){let r=[],s=[];for(let i=0;;){let c=!1;if(e=e.replace(/\{[^}]+\}/g,a=>{let x=`@\\${i}`;return s[i]=[x,a],i++,c=!0,x}),!c)break}let n=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let i=s.length-1;i>=0;i--){let[c]=s[i];for(let a=n.length-1;a>=0;a--)if(n[a].indexOf(c)!==-1){n[a]=n[a].replace(c,s[i][1]);break}}return this.root.insert(n,t,r,this.context,o),r}buildRegExp(){let e=this.root.buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0,o=[],r=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(s,n,i)=>typeof n<"u"?(o[++t]=Number(n),"$()"):(typeof i<"u"&&(r[Number(i)]=++t),"")),[new RegExp(`^${e}`),o,r]}};var he=[m,...Z].map(e=>e.toUpperCase()),We=[],lt=[/^$/,[],{}],pe={};function Be(e){return pe[e]??(pe[e]=new RegExp(e==="*"?"":`^${e.replace(/\/\*/,"(?:|/.*)")}$`))}function dt(){pe={}}function ht(e){let t=new De,o=[];if(e.length===0)return lt;let r=e.map(x=>[!/\*|\/:/.test(x[0]),...x]).sort(([x,f],[_,h])=>x?1:_?-1:f.length-h.length),s={};for(let x=0,f=-1,_=r.length;x<_;x++){let[h,w,b]=r[x];h?s[w]=[b.map(([d])=>[d,{}]),We]:f++;let g;try{g=t.insert(w,f,h)}catch(d){throw d===q?new te(w):d}h||(o[f]=b.map(([d,E])=>{let O={};for(E-=1;E>=0;E--){let[A,v]=g[E];O[A]=v}return[d,O]}))}let[n,i,c]=t.buildRegExp();for(let x=0,f=o.length;x<f;x++)for(let _=0,h=o[x].length;_<h;_++){let w=o[x][_]?.[1];if(!w)continue;let b=Object.keys(w);for(let g=0,d=b.length;g<d;g++)w[b[g]]=c[w[b[g]]]}let a=[];for(let x in i)a[x]=o[i[x]];return[n,a,s]}function j(e,t){if(e){for(let o of Object.keys(e).sort((r,s)=>s.length-r.length))if(Be(o).test(t))return[...e[o]]}}var ue=class{constructor(){this.name="RegExpRouter",this.middleware={[m]:{}},this.routes={[m]:{}}}add(e,t,o){var r;let{middleware:s,routes:n}=this;if(!s||!n)throw new Error(ee);he.indexOf(e)===-1&&he.push(e),s[e]||[s,n].forEach(a=>{a[e]={},Object.keys(a[m]).forEach(x=>{a[e][x]=[...a[m][x]]})}),t==="/*"&&(t="*");let i=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){let a=Be(t);e===m?Object.keys(s).forEach(x=>{var f;(f=s[x])[t]||(f[t]=j(s[x],t)||j(s[m],t)||[])}):(r=s[e])[t]||(r[t]=j(s[e],t)||j(s[m],t)||[]),Object.keys(s).forEach(x=>{(e===m||e===x)&&Object.keys(s[x]).forEach(f=>{a.test(f)&&s[x][f].push([o,i])})}),Object.keys(n).forEach(x=>{(e===m||e===x)&&Object.keys(n[x]).forEach(f=>a.test(f)&&n[x][f].push([o,i]))});return}let c=Q(t)||[t];for(let a=0,x=c.length;a<x;a++){let f=c[a];Object.keys(n).forEach(_=>{var h;(e===m||e===_)&&((h=n[_])[f]||(h[f]=[...j(s[_],f)||j(s[m],f)||[]]),n[_][f].push([o,i-x+a+1]))})}}match(e,t){dt();let o=this.buildAllMatchers();return this.match=(r,s)=>{let n=o[r],i=n[2][s];if(i)return i;let c=s.match(n[0]);if(!c)return[[],We];let a=c.indexOf("",1);return[n[1][a],c]},this.match(e,t)}buildAllMatchers(){let e={};return he.forEach(t=>{e[t]=this.buildMatcher(t)||e[m]}),this.middleware=this.routes=void 0,e}buildMatcher(e){let t=[],o=e===m;return[this.middleware,this.routes].forEach(r=>{let s=r[e]?Object.keys(r[e]).map(n=>[n,r[e][n]]):[];s.length!==0?(o||(o=!0),t.push(...s)):e!==m&&t.push(...Object.keys(r[m]).map(n=>[n,r[m][n]]))}),o?ht(t):null}};var be=class{constructor(e){this.name="SmartRouter",this.routers=[],this.routes=[],Object.assign(this,e)}add(e,t,o){if(!this.routes)throw new Error(ee);this.routes.push([e,t,o])}match(e,t){if(!this.routes)throw new Error("Fatal error");let{routers:o,routes:r}=this,s=o.length,n=0,i;for(;n<s;n++){let c=o[n];try{r.forEach(a=>{c.add(...a)}),i=c.match(e,t)}catch(a){if(a instanceof te)continue;throw a}this.match=c.match.bind(c),this.routers=[c],this.routes=void 0;break}if(n===s)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,i}get activeRouter(){if(this.routes||this.routers.length!==1)throw new Error("No active router has been determined yet.");return this.routers[0]}};var me=class{constructor(e,t,o){if(this.order=0,this.params={},this.children=o||{},this.methods=[],this.name="",e&&t){let r={};r[e]={handler:t,possibleKeys:[],score:0,name:this.name},this.methods=[r]}this.patterns=[]}insert(e,t,o){this.name=`${e} ${t}`,this.order=++this.order;let r=this,s=ke(t),n=[],i=[];for(let x=0,f=s.length;x<f;x++){let _=s[x];if(Object.keys(r.children).includes(_)){i.push(...r.patterns),r=r.children[_];let w=le(_);w&&n.push(w[1]);continue}r.children[_]=new me;let h=le(_);h&&(r.patterns.push(h),i.push(...r.patterns),n.push(h[1])),i.push(...r.patterns),r=r.children[_]}r.methods.length||(r.methods=[]);let c={},a={handler:o,possibleKeys:n.filter((x,f,_)=>_.indexOf(x)===f),name:this.name,score:this.order};return c[e]=a,r.methods.push(c),r}gHSets(e,t,o,r){let s=[];for(let n=0,i=e.methods.length;n<i;n++){let c=e.methods[n],a=c[t]||c[m],x={};a!==void 0&&(a.params={},a.possibleKeys.forEach(f=>{let _=x[a.name];a.params[f]=r[f]&&!_?r[f]:o[f]??r[f],x[a.name]=!0}),s.push(a))}return s}search(e,t){let o=[];this.params={};let s=[this],n=_e(t);for(let c=0,a=n.length;c<a;c++){let x=n[c],f=c===a-1,_=[];for(let h=0,w=s.length;h<w;h++){let b=s[h],g=b.children[x];g&&(g.params=b.params,f===!0?(g.children["*"]&&o.push(...this.gHSets(g.children["*"],e,b.params,{})),o.push(...this.gHSets(g,e,b.params,{}))):_.push(g));for(let d=0,E=b.patterns.length;d<E;d++){let O=b.patterns[d],A={...b.params};if(O==="*"){let p=b.children["*"];p&&(o.push(...this.gHSets(p,e,b.params,{})),_.push(p));continue}if(x==="")continue;let[v,k,C]=O,H=b.children[v],S=n.slice(c).join("/");if(C instanceof RegExp&&C.test(S)){A[k]=S,o.push(...this.gHSets(H,e,b.params,A));continue}(C===!0||C instanceof RegExp&&C.test(x))&&typeof v=="string"&&(A[k]=x,f===!0?(o.push(...this.gHSets(H,e,A,b.params)),H.children["*"]&&o.push(...this.gHSets(H.children["*"],e,A,b.params))):(H.params=A,_.push(H)))}}s=_}return[o.sort((c,a)=>c.score-a.score).map(({handler:c,params:a})=>[c,a])]}};var ge=class{constructor(){this.name="TrieRouter",this.node=new me}add(e,t,o){let r=Q(t);if(r){for(let s of r)this.node.insert(e,s,o);return}this.node.insert(e,t,o)}match(e,t){return this.node.search(e,t)}};var ye=class extends Ue{constructor(e={}){super(e),this.router=e.router??new be({routers:[new ue,new ge]})}};function V(e){let t=/^([^:/?#]+)\/([-a-z0-9A-Z.]+)/,o=e.match(t),r,s;return o&&(r=o[1],s=o[2]),{protocol:r,host:s}}var U;function pt(){return typeof Bun<"u"||typeof process<"u"&&process.versions&&process.versions.node}function Fe(e){pt()?(console.log("node environment!"),import("fs/promises").then(t=>{t.readFile("./config.json","utf8").then(o=>{U=JSON.parse(o),console.log("Configuration loaded:",U),e(U)}).catch(o=>{console.error("Error loading the configuration file:",o)})})):(console.log("cloudflare environment!"),U={proxy_url:"https://server2.ai1to1.com",token_prefix:"/user22334455/",local_listen_port:5006},console.log("Configuration loaded:",U),e(U))}function $(){return U}var ut=[{domain:"accounts.youtube.com",replacements:[{regex:"window.parent.postMessage\\((.*?), .https:.*?;",replacement:"window.parent.postMessage($1);"}]}];function qe({body:e,proxy_real_host:t,proxy_url_prefix:o}){let r=ut.find(n=>t.includes(n.domain));if(!r)return e;let s=e;return r.replacements.forEach(({regex:n,replacement:i})=>{let c=i.replace(/\$proxy_url_prefix/g,o);s=s.replace(new RegExp(n,"g"),c)}),s}var ie;var bt=({location_value:e,proxy_url_prefix:t,proxy_real_protocol:o,proxy_real_host:r})=>{let s={"(http[s]?)://([-a-z0-9A-Z.]+)":`${t}$1/$2`};for(let n in s){let i=new RegExp(n,"g");e=e.replace(i,s[n])}return e};function mt({location_value:e,proxy_url_prefix:t,proxy_real_protocol:o,proxy_real_host:r}){return bt({location_value:e,proxy_url_prefix:t,proxy_real_protocol:o,proxy_real_host:r})}function gt(){return typeof Bun<"u"||typeof process<"u"&&process.versions&&process.versions.node}async function yt(e,t){return gt()?await wt(e,t):await vt(e,t)}async function wt(e,t){ie||(ie=await import("zlib"));try{return t==="br"?ie.brotliCompressSync(e):t==="gzip"?ie.gzipSync(e):e}catch(o){return console.error("Compression error:",o),e}}async function vt(e,t){if(typeof CompressionStream<"u")try{let o;if(t==="gzip"||t==="br")o=e.pipeThrough(new CompressionStream(t));else throw new Error("Unsupported encoding for compression");let r=o.getReader(),s=[],n;for(;!(n=await r.read()).done;)s.push(n.value);return new Uint8Array(s.reduce((c,a)=>c.concat(Array.from(a)),[]))}catch(o){return console.error("Compression error:",o),e}else return console.error("Compression not supported in this environment or for the specified format."),e}async function je({proxyResponse:e,newResHeaders:t,req:o}){let r=$(),s=r.proxy_url+r.token_prefix,n=o.proxy_real_protocol,i=o.proxy_real_host,f=`<script>
          const proxy_url_prefix = '${s}';
          const proxy_real_protocol = '${n}';
          const proxy_real_host = '${i}';
          const config_proxy_url = '${r.proxy_url}';
          const config_token_prefix = '${r.token_prefix}';
        `+"function _0x4b57(_0x53af44,_0x2fb704){const _0x5193db=_0x5193();return _0x4b57=function(_0x4b5714,_0x4ec1d8){_0x4b5714=_0x4b5714-0x104;let _0x398c7f=_0x5193db[_0x4b5714];return _0x398c7f;},_0x4b57(_0x53af44,_0x2fb704);}const _0x3a3b04=_0x4b57;(function(_0x5b70c7,_0x54396f){const _0x4fa234=_0x4b57,_0x4f25e0=_0x5b70c7();while(!![]){try{const _0x38e806=-parseInt(_0x4fa234(0x10e))/0x1*(parseInt(_0x4fa234(0x116))/0x2)+-parseInt(_0x4fa234(0x12e))/0x3+parseInt(_0x4fa234(0x11e))/0x4+-parseInt(_0x4fa234(0x147))/0x5*(parseInt(_0x4fa234(0x10f))/0x6)+-parseInt(_0x4fa234(0x14b))/0x7*(parseInt(_0x4fa234(0x12f))/0x8)+parseInt(_0x4fa234(0x141))/0x9*(-parseInt(_0x4fa234(0x121))/0xa)+parseInt(_0x4fa234(0x135))/0xb;if(_0x38e806===_0x54396f)break;else _0x4f25e0['push'](_0x4f25e0['shift']());}catch(_0x4430e3){_0x4f25e0['push'](_0x4f25e0['shift']());}}}(_0x5193,0x981de));function _0x5193(){const _0x42effc=['13866YzecPy','click','some','http','childList','attributes','data-link','&proxy_real_host=','4740808RyFktI','self','documentElement','10tBuUPJ','proxy_worker_registration','blob:','serviceWorker','length','hookFormSubmit: Form element has been removed from the DOM, skipping action change.','setAttribute','startsWith','src','addEventListener','substring','/siteproxy_service_worker.js?proxy_real_protocol=','type','2212176VKvCGG','8691112TEmWlv','includes','disconnect','submit','action','href','36245858ojyoVS','/https','!!! proxy service worker already registered.','Form submitted, new action:','iframe','/https/','DOMContentLoaded','scope','after:','postMessage','active','tagName','9475209ynmXsE','target','replace','clickListenerAdded','then','error','7615bUQKEr','log','childNodes','data-url','7AxzQEi','siteproxy_service_worker.js','load','ELEMENT_NODE','observe','slice','getAttribute','$2/$3','forEach','parentNode','//https','attributeName','host:','36mcvtCt','2880NVVsSg','toLowerCase','siteproxy_service_worker registration failed: ','top','link','PROXY_CUR_LOCATION','hasAttribute'];_0x5193=function(){return _0x42effc;};return _0x5193();}function regReplacement(_0x49ecf6){const _0x55f45a=_0x4b57;if(_0x49ecf6[_0x55f45a(0x130)](config_token_prefix))return _0x49ecf6;let _0x357b7e='';if(_0x49ecf6['startsWith'](_0x55f45a(0x123)))return _0x49ecf6;_0x49ecf6[_0x55f45a(0x128)](config_proxy_url[_0x55f45a(0x106)](0x0,0x4)+config_proxy_url[_0x55f45a(0x106)](0x4))&&(_0x49ecf6=_0x49ecf6[_0x55f45a(0x12b)](config_proxy_url[_0x55f45a(0x106)](0x4)[_0x55f45a(0x125)]+0x4));const _0x5492e0={'()(http[s]?)://([-a-z0-9A-Z.]+)':_0x55f45a(0x119)+proxy_url_prefix[_0x55f45a(0x106)](0x4)+_0x55f45a(0x108)};for(let _0xdae5f6 in _0x5492e0){let _0x21d5a4=new RegExp(_0xdae5f6,'g');_0x49ecf6=_0x49ecf6[_0x55f45a(0x143)](_0x21d5a4,_0x5492e0[_0xdae5f6]);}let _0x16d63e=config_proxy_url[_0x55f45a(0x12b)](config_proxy_url['indexOf']('//'));_0x49ecf6[_0x55f45a(0x128)](_0x16d63e)&&(_0x49ecf6=_0x49ecf6[_0x55f45a(0x12b)](_0x16d63e['length']));let _0x339db2=_0x55f45a(0x119)+proxy_url_prefix[_0x55f45a(0x106)](0x4)+proxy_real_protocol+'/'+proxy_real_host,_0x3e9504='http'+proxy_url_prefix['slice'](0x4);if(_0x49ecf6[_0x55f45a(0x128)]('//'))_0x49ecf6=_0x3e9504+_0x55f45a(0x13a)+_0x49ecf6['slice'](0x2),_0x49ecf6=_0x49ecf6['replace'](_0x55f45a(0x10b),_0x55f45a(0x136));else _0x49ecf6[_0x55f45a(0x128)]('/')&&(_0x49ecf6=_0x339db2+_0x49ecf6);return _0x49ecf6;}const config={'attributes':!![],'childList':!![],'subtree':!![],'attributeOldValue':!![],'characterDataOldValue':!![],'attributeFilter':[_0x3a3b04(0x129),_0x3a3b04(0x134),'action',_0x3a3b04(0x14a),'srcset']};function attributeChanged(_0x5cbbed,_0x1070db){const _0x318247=_0x3a3b04;_0x1070db[_0x318247(0x131)](),_0x5cbbed['forEach'](_0x5be79f=>{const _0x4399ac=_0x318247;switch(_0x5be79f[_0x4399ac(0x12d)]){case _0x4399ac(0x11b):let _0x2d9e7c=_0x5be79f[_0x4399ac(0x142)][_0x4399ac(0x107)](_0x5be79f[_0x4399ac(0x10c)]);if(_0x5be79f[_0x4399ac(0x10c)]==='src'&&_0x5be79f[_0x4399ac(0x142)]['tagName'][_0x4399ac(0x110)]()===_0x4399ac(0x139)||_0x5be79f[_0x4399ac(0x10c)]===_0x4399ac(0x134)&&_0x5be79f[_0x4399ac(0x142)]['tagName'][_0x4399ac(0x110)]()===_0x4399ac(0x113)||window[_0x4399ac(0x11f)]!==window['top']){let _0x5ea268=regReplacement(_0x2d9e7c);_0x5be79f['target']['setAttribute'](_0x5be79f[_0x4399ac(0x10c)],_0x5ea268);}else{if(_0x5be79f[_0x4399ac(0x10c)]===_0x4399ac(0x134))hookclickAndSetAttribute(_0x5be79f[_0x4399ac(0x142)],_0x4399ac(0x134));else _0x5be79f[_0x4399ac(0x10c)]===_0x4399ac(0x133)&&hookFormSubmit(_0x5be79f[_0x4399ac(0x142)]);}(_0x5be79f['attributeName']===_0x4399ac(0x134)||_0x5be79f[_0x4399ac(0x10c)]===_0x4399ac(0x129))&&(_0x2d9e7c&&_0x2d9e7c[_0x4399ac(0x12b)](0x0,0x2)!=='//'&&_0x2d9e7c[_0x4399ac(0x12b)](0x0,0x1)==='/'&&postUrl2ServiceWorker(_0x2d9e7c,proxy_real_protocol,proxy_real_host));if([_0x4399ac(0x11c),_0x4399ac(0x14a)][_0x4399ac(0x130)](_0x5be79f[_0x4399ac(0x10c)])){let _0x163f14=regReplacement(_0x2d9e7c);_0x5be79f[_0x4399ac(0x142)][_0x4399ac(0x127)](_0x5be79f[_0x4399ac(0x10c)],_0x163f14);}break;case _0x4399ac(0x11a):_0x5be79f['addedNodes'][_0x4399ac(0x109)](_0xf512de=>{traverseAndModifyNode(_0xf512de);});break;}}),_0x1070db[_0x318247(0x105)](document[_0x318247(0x120)],config);}function traverseAndModifyNode(_0x19246e){const _0x3153ab=_0x3a3b04;_0x19246e[_0x3153ab(0x149)][_0x3153ab(0x109)](_0x5a59a5=>{traverseAndModifyNode(_0x5a59a5);});if(_0x19246e['nodeType']===Node[_0x3153ab(0x104)]){const _0x54e9bf=[_0x3153ab(0x129),'href',_0x3153ab(0x133),_0x3153ab(0x11c),_0x3153ab(0x14a)];_0x54e9bf['forEach'](_0xcc0d33=>{const _0x5853f3=_0x3153ab;if(_0x19246e[_0x5853f3(0x115)](_0xcc0d33)){let _0x2c7bf6=_0x19246e[_0x5853f3(0x107)](_0xcc0d33);if(_0xcc0d33===_0x5853f3(0x129)&&_0x19246e[_0x5853f3(0x140)]['toLowerCase']()===_0x5853f3(0x139)||_0xcc0d33===_0x5853f3(0x134)&&_0x19246e[_0x5853f3(0x140)]['toLowerCase']()===_0x5853f3(0x113)||window[_0x5853f3(0x11f)]!==window[_0x5853f3(0x112)]){let _0x4afc6d=regReplacement(_0x2c7bf6);_0x19246e['setAttribute'](_0xcc0d33,_0x4afc6d);}else{if(_0xcc0d33===_0x5853f3(0x134))hookclickAndSetAttribute(_0x19246e,'href');else{if(_0xcc0d33===_0x5853f3(0x133))hookFormSubmit(_0x19246e);else{if([_0x5853f3(0x11c),'data-url'][_0x5853f3(0x130)](_0xcc0d33)){let _0x17e6d4=regReplacement(_0x2c7bf6);_0x19246e[_0x5853f3(0x127)](_0xcc0d33,_0x17e6d4);}}}}(_0xcc0d33===_0x5853f3(0x129)||_0xcc0d33===_0x5853f3(0x134))&&(_0x2c7bf6&&_0x2c7bf6['substring'](0x0,0x2)!=='//'&&_0x2c7bf6[_0x5853f3(0x12b)](0x0,0x1)==='/'&&postUrl2ServiceWorker(_0x2c7bf6,proxy_real_protocol,proxy_real_host));}});}}const observer=new MutationObserver(attributeChanged);observer[_0x3a3b04(0x105)](document[_0x3a3b04(0x120)],config),document['addEventListener'](_0x3a3b04(0x13b),()=>{});function hookclickAndSetAttribute(_0x20fdd6,_0x5e8743){const _0xe4e5a3=_0x3a3b04;if(!(_0x20fdd6 instanceof HTMLElement)||!_0x20fdd6[_0xe4e5a3(0x115)](_0x5e8743)||_0x20fdd6[_0xe4e5a3(0x144)])return;_0x20fdd6[_0xe4e5a3(0x144)]=!![],_0x20fdd6[_0xe4e5a3(0x12a)](_0xe4e5a3(0x117),function(_0x20d34a){const _0x55d2d1=_0xe4e5a3,_0x56002a=regReplacement(_0x20fdd6[_0x55d2d1(0x107)](_0x5e8743));_0x20fdd6[_0x55d2d1(0x127)](_0x5e8743,_0x56002a),console[_0x55d2d1(0x148)]('click element, modifying ',_0x5e8743,_0x55d2d1(0x13d),_0x56002a);});}function hookFormSubmit(_0x32927a){const _0x2fc1ab=_0x3a3b04;if(!(_0x32927a instanceof HTMLFormElement)||!_0x32927a['hasAttribute'](_0x2fc1ab(0x133)))return;_0x32927a[_0x2fc1ab(0x12a)]('submit',function(_0x1c26c2){const _0x1f65a6=_0x2fc1ab;if(!_0x32927a||!_0x32927a[_0x1f65a6(0x10a)]){console[_0x1f65a6(0x146)](_0x1f65a6(0x126));return;}_0x1c26c2['preventDefault'](),_0x1c26c2[_0x1f65a6(0x142)][_0x1f65a6(0x133)]=regReplacement(_0x1c26c2[_0x1f65a6(0x142)][_0x1f65a6(0x133)]),console[_0x1f65a6(0x148)](_0x1f65a6(0x138),_0x1c26c2[_0x1f65a6(0x142)][_0x1f65a6(0x133)]),_0x1c26c2[_0x1f65a6(0x142)][_0x1f65a6(0x132)]();});}function postUrl2ServiceWorker(_0x3f1d4c,_0x346306,_0x203dba){const _0x26d53e=_0x3a3b04;window[_0x26d53e(0x122)]&&window[_0x26d53e(0x122)]['active']&&window[_0x26d53e(0x122)][_0x26d53e(0x13f)][_0x26d53e(0x13e)]({'type':'PROXY_URL_HOST_MAP','data':{'pathname':_0x3f1d4c,'real_protocol':_0x346306,'real_host':_0x203dba}});}function post_location_to_service_worker(){const _0x2cfa60=_0x3a3b04;if(!proxy_real_protocol||window['self']!==window[_0x2cfa60(0x112)])return;window['proxy_worker_registration']&&window[_0x2cfa60(0x122)][_0x2cfa60(0x13f)]&&window[_0x2cfa60(0x122)][_0x2cfa60(0x13f)][_0x2cfa60(0x13e)]({'type':_0x2cfa60(0x114),'data':{'protocol':proxy_real_protocol,'host':proxy_real_host}});}'serviceWorker'in navigator&&navigator[_0x3a3b04(0x124)]['getRegistrations']()[_0x3a3b04(0x145)](function(_0x3359f7){const _0x30b90c=_0x3a3b04;var _0x59dea3=_0x3359f7[_0x30b90c(0x118)](function(_0x271973){const _0xfb7409=_0x30b90c;let _0x2f88fd=_0x271973[_0xfb7409(0x13f)]&&_0x271973[_0xfb7409(0x13f)]['scriptURL']['includes'](_0xfb7409(0x14c));_0x2f88fd&&(console[_0xfb7409(0x148)](_0xfb7409(0x137)),window[_0xfb7409(0x122)]=_0x271973,post_location_to_service_worker());});!_0x59dea3&&window['addEventListener'](_0x30b90c(0x14d),function(){const _0x19dbb3=_0x30b90c;if(window[_0x19dbb3(0x122)]&&window[_0x19dbb3(0x122)]['active'])return;navigator['serviceWorker']['register'](_0x19dbb3(0x12c)+proxy_real_protocol+_0x19dbb3(0x11d)+proxy_real_host)['then'](function(_0x59cdb2){const _0x2685f9=_0x19dbb3;console[_0x2685f9(0x148)]('siteproxy_service_worker registration successful with scope: ',_0x59cdb2[_0x2685f9(0x13c)],'protocol:',proxy_real_protocol,_0x2685f9(0x10d),proxy_real_host),window[_0x2685f9(0x122)]=_0x59cdb2,post_location_to_service_worker();},function(_0x5e2639){const _0x58114e=_0x19dbb3;console[_0x58114e(0x148)](_0x58114e(0x111),_0x5e2639);});});});"+"<\/script>",_=e.headers.get("content-encoding"),h=e.headers.get("content-type")||"",w=h.includes("text/html"),b=h.includes("javascript");if([301,302,303,307,308].includes(e.status)){let v=e.headers.get("location");v&&t.set("Location",mt({location_value:v,proxy_url_prefix:s,proxy_real_protocol:n,proxy_real_host:i}))}let g=e.body,d,E;if(_&&(d=await e.arrayBuffer(),E=d.byteLength),w&&e.status<400){if(_||(d=await e.arrayBuffer(),E=d.byteLength),!E||E<10)return e.status===204&&(d=void 0),new Response(d,{status:e.status,headers:t});if(d=new TextDecoder("utf-8").decode(d),w&&(d.indexOf("<head")!==-1?d=d.replace(/<head(.*?)>/,`<head$1>${f}`):d.indexOf("<body")!==-1?d=d.replace(/<body(.*?)>/,`<body$1>${f}`):d=d.replace(/<html(.*?)>/,`<html$1>${f}`),d=qe({body:d,proxy_real_host:i,proxy_url_prefix:s})),o.proxy_real_protocol){let k=`proxy_real_protocol=${o.proxy_real_protocol}; Path=/; HttpOnly`,C=`proxy_real_host=${o.proxy_real_host}; Path=/; HttpOnly`;t.append("set-cookie",k),t.append("set-cookie",C),t.delete("x-frame-options")}g=d}_&&(d=await yt(d,"gzip"),g=d,t.set("content-length",String(d.length)),t.set("content-encoding","gzip"));let O=e.headers.get("transfer-encoding");return O&&t.set("transfer-encoding",O),(e.status===204||[301,302,303,307,308].includes(e.status))&&(g=void 0),new Response(g,{status:e.status,headers:t})}function Et(e){let t=$(),o=t.token_prefix,r=t.proxy_url+o+"https/",s=t.proxy_url+o+"http/",n=e,i=e.indexOf(r);if(i!==-1){let a=i+r.length,x=e.substring(a);n=e.substring(0,i)+"https://"+x}let c=e.indexOf(s);if(c!==-1&&i===-1){let a=c+s.length,x=e.substring(a);n=e.substring(0,c)+"http://"+x}return n}var ze=async(e,t)=>{let o=$(),{req:r,res:s}=e,n=o.token_prefix,i=o.proxy_url.substring(o.proxy_url.indexOf("//")+2);i.indexOf(":")!==-1&&(i=i.substring(0,i.indexOf(":")));let c=new URL(r.url);if(!c.pathname.startsWith(n))return t();let a=c.pathname.substring(n.length),x="",{protocol:f,host:_}=V(a);if(f!=="http"&&f!=="https")return t();x=`${f}://${_}`,r.proxy_real_protocol=f,r.proxy_real_host=_;let h=v=>{let k=v.replace(new RegExp(`^${n}${f}/[^/]+`),"");return k=Et(k),k},w=(v,k,C)=>{let H=$(),S=H.proxy_url+H.token_prefix,p={};return v.forEach((Ve,Ye)=>{p[Ye]=Ve}),p["siteproxy-newreferer"]?(p.referer=p["siteproxy-newreferer"],p.origin=p["siteproxy-newreferer"],delete p["siteproxy-newreferer"]):p.referer&&p.referer.startsWith(S)?(p.referer=p.referer.substring(S.length),p.referer.startsWith("https/")?p.referer="https://"+p.referer.substring(6):p.referer.startsWith("http/")&&(p.referer="http://"+p.referer.substring(5)),p.origin=k+"://"+C):p.origin===H.proxy_url&&(p.origin=k+"://"+C),p},b=v=>{let k=new Headers;v.forEach((H,S)=>{S!=="set-cookie"&&k.set(S,H)});let C=v.getSetCookie();return C&&(C=C.map(H=>{let S=H.replace(/Domain=[^;]*?(;|$)/ig,i?`Domain=${i};`:"").replace(/Path=([^;]*?)(;|$)/ig,`Path=${o.token_prefix}${r.proxy_real_protocol}/${r.proxy_real_host}$1$2`).replace(/Expires=[^;]*?(;|$)/ig,"").replace(/Max-Age=[^;]*?(;|$)/ig,"");/Secure/i.test(S)||(S+="; Secure"),/HttpOnly/i.test(S)||(S+="; HttpOnly"),S=S.replace(";;",";"),k.append("set-cookie",S)})),k},g=x+h(c.pathname)+c.search,d={...w(e.req.raw.headers,f,_),host:_},E=e.req.method!=="GET"?await e.req.arrayBuffer():void 0;E&&E.byteLength===0&&(E=void 0);let O;try{O=await fetch(g,{method:e.req.method,headers:d,body:E,redirect:"manual"})}catch(v){throw console.log("An error occurred during fetch operation:"),console.log("Error:",v.message),console.log("Proxy URL:",g),console.log("Method:",e.req.method),console.log("Headers:",d),console.log("Body:",E),v}let A=b(O.headers);return e.res=await je({proxyResponse:O,newResHeaders:A,req:r}),e.res};var Ge=async(e,t)=>{let o=$(),r=o.token_prefix,s=o.proxy_url+o.token_prefix,n=new URL(e.req.url);if(n.pathname==="/siteproxy_service_worker.js"){let i=n.searchParams,c=i.get("proxy_real_protocol"),a=i.get("proxy_real_host");if(!a)return t();let _=`
      const proxy_url_prefix = '${s}';
      const proxy_real_protocol = '${c}';
      const proxy_real_host = '${a}';
      const config_proxy_url = '${o.proxy_url}';
      const config_token_prefix = '${o.token_prefix}';
    `+"const _0x29211c=_0xf904;(function(_0x2f6a96,_0x17a354){const _0x177b6c=_0xf904,_0x2b8333=_0x2f6a96();while(!![]){try{const _0x3dbb43=parseInt(_0x177b6c(0xf4))/0x1*(parseInt(_0x177b6c(0x105))/0x2)+parseInt(_0x177b6c(0xe6))/0x3*(parseInt(_0x177b6c(0xde))/0x4)+-parseInt(_0x177b6c(0xfd))/0x5*(parseInt(_0x177b6c(0xdf))/0x6)+parseInt(_0x177b6c(0x109))/0x7*(-parseInt(_0x177b6c(0xe9))/0x8)+-parseInt(_0x177b6c(0xf3))/0x9+parseInt(_0x177b6c(0xdc))/0xa+parseInt(_0x177b6c(0xdd))/0xb;if(_0x3dbb43===_0x17a354)break;else _0x2b8333['push'](_0x2b8333['shift']());}catch(_0x5ecb74){_0x2b8333['push'](_0x2b8333['shift']());}}}(_0x4a1c,0x2479b));function _0xf904(_0x12459a,_0x56e971){const _0x4a1cb2=_0x4a1c();return _0xf904=function(_0xf904f4,_0x4f6dae){_0xf904f4=_0xf904f4-0xd7;let _0x363aa5=_0x4a1cb2[_0xf904f4];return _0x363aa5;},_0xf904(_0x12459a,_0x56e971);}function _0x4a1c(){const _0x4f5b50=['log','$1://$2','toUpperCase','lasttime','undefined','headers','68680HpTiyX','arrayBuffer','cors','pathname','request','include','GET','type','44TdaHnH','PROXY_CUR_LOCATION','activate','search','872599nZOLQC','fetch','url','data','startsWith','://','includes','redirect','POST','protocol','42850Khuwaw','1947000ThKegF','888dsuccF','66EYHXSu','PUT','addEventListener','clone','claim','siteproxy-newreferer','waitUntil','2916zHDWhq','body','proxy_target_host','8SrJMrS','proxy_target_protocol','now','install','Receive and use PROXY_CUR_LOCATION in service worker:','skipWaiting','respondWith','using pathHostMap, modifiedUrl:','method','real_protocol','1254195Rneypw','7611yFiFMP','host','get'];_0x4a1c=function(){return _0x4f5b50;};return _0x4a1c();}var pathHostMap={};function cleanupOutdatedItems(){const _0xd37200=_0xf904,_0x277713=Date[_0xd37200(0xeb)]();for(let _0x1bbe58 in pathHostMap){_0x277713>pathHostMap[_0x1bbe58]['lasttime']+0x7530&&delete pathHostMap[_0x1bbe58];}}setInterval(cleanupOutdatedItems,0x7d0);let requestBodyModify=_0x219c0a=>{const _0x1b2e6e=_0xf904;return _0x219c0a=_0x219c0a['replace'](new RegExp(proxy_url_prefix+'(http[s]?)/([^/]+/)','g'),_0x1b2e6e(0xf8)),_0x219c0a;};self[_0x29211c(0xe1)]('message',_0x3b3216=>{const _0xd582bb=_0x29211c;if(_0x3b3216[_0xd582bb(0x10c)][_0xd582bb(0x104)]===_0xd582bb(0x106))console[_0xd582bb(0xf7)](_0xd582bb(0xed),_0x3b3216['data'][_0xd582bb(0x10c)]),_0x3b3216['data']['data'][_0xd582bb(0xdb)]!==_0xd582bb(0xfb)&&_0x3b3216[_0xd582bb(0x10c)][_0xd582bb(0x10c)][_0xd582bb(0xf5)]!==_0xd582bb(0xfb)&&(_0x3b3216['data']['data'][_0xd582bb(0xdb)]!==self[_0xd582bb(0xea)]||_0x3b3216['data'][_0xd582bb(0x10c)]['host']!==self['proxy_target_host'])&&(self[_0xd582bb(0xea)]=_0x3b3216[_0xd582bb(0x10c)][_0xd582bb(0x10c)][_0xd582bb(0xdb)],self[_0xd582bb(0xe8)]=_0x3b3216[_0xd582bb(0x10c)][_0xd582bb(0x10c)][_0xd582bb(0xf5)]);else _0x3b3216['data'][_0xd582bb(0x104)]==='PROXY_URL_HOST_MAP'&&(pathHostMap[_0x3b3216[_0xd582bb(0x10c)][_0xd582bb(0x10c)][_0xd582bb(0x100)]]={'real_protocol':_0x3b3216['data'][_0xd582bb(0x10c)][_0xd582bb(0xf2)],'real_host':_0x3b3216['data'][_0xd582bb(0x10c)]['real_host'],'lasttime':Date[_0xd582bb(0xeb)]()});}),self[_0x29211c(0xe1)](_0x29211c(0xec),_0x11291e=>{const _0x2a233a=_0x29211c;self[_0x2a233a(0xee)]();}),self[_0x29211c(0xe1)](_0x29211c(0x107),_0x17a448=>{const _0x4d4c51=_0x29211c;_0x17a448[_0x4d4c51(0xe5)](self['clients'][_0x4d4c51(0xe3)]());}),self[_0x29211c(0xe1)](_0x29211c(0x10a),_0x19ebee=>{const _0x4b9ec4=_0x29211c,_0xff177f=new URL(_0x19ebee[_0x4b9ec4(0x101)][_0x4b9ec4(0x10b)]);let _0x4ebcd7=self[_0x4b9ec4(0xea)]||proxy_real_protocol,_0x4c3ec1=self[_0x4b9ec4(0xe8)]||proxy_real_host,_0x54a88e=_0x4ebcd7+_0x4b9ec4(0xd7)+_0x4c3ec1,_0x3863c6=_0x19ebee[_0x4b9ec4(0x101)][_0x4b9ec4(0x10b)],_0x6ad06b=requestBodyModify(_0xff177f[_0x4b9ec4(0x108)]);if(pathHostMap[_0xff177f[_0x4b9ec4(0x100)]]){const {real_protocol:_0x15dd61,real_host:_0x3b4a13}=pathHostMap[_0xff177f[_0x4b9ec4(0x100)]];_0x3863c6=proxy_url_prefix+_0x15dd61+'/'+_0x3b4a13+_0xff177f[_0x4b9ec4(0x100)]+_0x6ad06b,pathHostMap[_0xff177f[_0x4b9ec4(0x100)]][_0x4b9ec4(0xfa)]=Date[_0x4b9ec4(0xeb)](),console['log'](_0x4b9ec4(0xf0),_0x3863c6);}else _0x4ebcd7!=_0x4b9ec4(0xfb)&&(!_0xff177f[_0x4b9ec4(0x100)][_0x4b9ec4(0x10d)](config_token_prefix)&&(_0x4c3ec1!==_0xff177f['host']&&!config_proxy_url['endsWith'](_0xff177f[_0x4b9ec4(0xf5)])&&(_0x4c3ec1=_0xff177f[_0x4b9ec4(0xf5)]),_0x3863c6=proxy_url_prefix+_0x4ebcd7+'/'+_0x4c3ec1+_0xff177f['pathname']+_0x6ad06b));if(_0x3863c6!==_0x19ebee[_0x4b9ec4(0x101)]['url']&&_0x19ebee['request']['method'][_0x4b9ec4(0xf9)]()===_0x4b9ec4(0x103)){const _0x968f0a=Response[_0x4b9ec4(0xd9)](_0x3863c6,0x12e);_0x19ebee[_0x4b9ec4(0xef)](_0x968f0a);return;}let _0x1062a1=new Headers(_0x19ebee[_0x4b9ec4(0x101)][_0x4b9ec4(0xfc)]);_0x1062a1['set'](_0x4b9ec4(0xe4),_0x54a88e);const _0x18e519={'method':_0x19ebee['request'][_0x4b9ec4(0xf1)],'headers':_0x1062a1,'mode':_0x4b9ec4(0xff),'credentials':_0x4b9ec4(0x102),'redirect':_0x19ebee['request']['redirect']};if([_0x4b9ec4(0xda),_0x4b9ec4(0xe0),'PATCH'][_0x4b9ec4(0xd8)](_0x19ebee[_0x4b9ec4(0x101)][_0x4b9ec4(0xf1)][_0x4b9ec4(0xf9)]())){const _0x36f4d2=_0x19ebee['request'][_0x4b9ec4(0xe2)]();_0x19ebee[_0x4b9ec4(0xef)](((async()=>{const _0x30108e=_0x4b9ec4,_0x26e91d=_0x36f4d2[_0x30108e(0xfc)][_0x30108e(0xf6)]('Content-Type');if(_0x26e91d&&_0x26e91d[_0x30108e(0xd8)]('text')){let _0x4787e7=await _0x36f4d2['text']();_0x18e519[_0x30108e(0xe7)]=requestBodyModify(_0x4787e7);}else{let _0x35f66f=await _0x36f4d2[_0x30108e(0xfe)]();_0x18e519[_0x30108e(0xe7)]=_0x35f66f;}const _0x52da48=new Request(_0x3863c6,_0x18e519);return fetch(_0x52da48);})()));}else{const _0x5cc93f=new Request(_0x3863c6,_0x18e519);_0x19ebee['respondWith'](fetch(_0x5cc93f));}});";return e.text(_,200,{"Content-Type":"application/javascript"})}return t()};var Rt=e=>{let t={};return e.split(";").forEach(o=>{let[r,s]=o.split("=").map(n=>n.trim());t[r]=s}),t},Ke=async(e,t)=>{let o=$(),r=o.proxy_url+o.token_prefix,s=new URL(e.req.url),n=s.pathname;s.pathname.startsWith(o.token_prefix)&&(n=s.pathname.substring(o.token_prefix.length));let i=n.indexOf(o.token_prefix);if(i!==-1){n=n.substring(i+o.token_prefix.length);let{protocol:f,host:_}=V(n);if(f==="http"||f==="https"){n=n.substring(n.indexOf(_)+_.length);let h=`${r}${f}/${_}${n}${s.search}`;return e.redirect(h)}}let{protocol:c,host:a}=V(n);if(n===""){let f=r+atob("aHR0cHMvd3d3Lm5ldHB0b3AuY29t");return e.redirect(f)}else if(c!=="http"&&c!=="https"){let f=Rt(e.req.raw.headers.get("cookie")||"");if(c=f.proxy_real_protocol,a=f.proxy_real_host,c&&a){let _=`${r}${c}/${a}${n}${s.search}`;return e.redirect(_)}}let x=kt(s.search);if(x!==s.search){let f=s.protocol+"//"+s.host+s.pathname+x;return e.redirect(f)}await t()},kt=e=>{let t=$(),o=t.proxy_url+t.token_prefix,r=e.replace(new RegExp(`${o}(http[s]?)/([^/]+)`),"$1://$2");return r=r||"",r};function St(){return typeof Bun<"u"||typeof process<"u"&&process.versions&&process.versions.node}Fe(e=>{let t=new ye;t.use("*",async(r,s)=>{await s()}),t.use("*",async(r,s)=>{await s(),r.res.headers.delete("Content-Security-Policy"),r.res.headers.delete("Content-Security-Policy-Report-Only")}),t.use("*",Ge),t.use("*",Ke),t.use("*",ze),t.use("*",async(r,s)=>{try{await s()}catch(n){return console.error(`Error in middleware for ${r.req.url}: ${n.message}`),r.text(`Internal Server Error: ${n.message}`,500)}});let o=parseInt(e.local_listen_port);console.log(`Running at http://localhost:${o}`),St()?import("@hono/node-server").then(({serve:r})=>{r({fetch:t.fetch,port:e.local_listen_port},s=>{console.log(`Listening on http://localhost:${s.port}`)})}).catch(r=>console.error("Failed to import @hono/node-server:",r)):addEventListener("fetch",r=>{r.respondWith(t.fetch(r.request))})});
